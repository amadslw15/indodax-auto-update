name: Indodax 24/7 Auto-Update to Google Sheets

on:
  # Jalankan setiap 5 menit
  schedule:
    - cron: '*/5 * * * *'
  # Bisa dijalankan manual
  workflow_dispatch:
  # Jalankan saat push kode
  push:
    branches: [ main ]

jobs:
  update-indodax:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install gspread pandas requests
    
    - name: Create simplified update script
      run: |
        cat > update_simple.py << 'EOF'
        import os
        import json
        import pandas as pd
        import requests
        from datetime import datetime
        
        print("ðŸ”§ DEBUG: Starting script...")
        
        # Debug: Print environment variables (without revealing secrets)
        sheets_url = os.environ.get('SHEETS_URL', '')
        print(f"ðŸ”§ DEBUG: SHEETS_URL exists: {'YES' if sheets_url else 'NO'}")
        
        # Coba akses Indodax API dulu
        try:
            print("ðŸŒ Testing Indodax API...")
            response = requests.get("https://indodax.com/api/tickers", timeout=10)
            if response.status_code == 200:
                data = response.json()
                pair_count = len(data.get('tickers', {}))
                print(f"âœ… Indodax API OK! Found {pair_count} pairs")
                
                # Simpan data ke file untuk debug
                with open('indodax_sample.json', 'w') as f:
                    json.dump(list(data['tickers'].keys())[:5], f)
                
                print("ðŸ“Š First 5 pairs:", list(data['tickers'].keys())[:5])
            else:
                print(f"âŒ Indodax API failed: {response.status_code}")
        except Exception as e:
            print(f"âŒ Indodax API error: {e}")
        
        print("ðŸ Script finished")
        EOF
    
    - name: Run debug script
      run: python update_simple.py
    
    - name: Upload debug files
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: debug-output
        path: |
          indodax_sample.json
